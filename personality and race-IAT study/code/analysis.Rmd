---
title: "Evaluations the relationship between the big-5 personality facets and implicit racial attitudes"
subtitle: "Analysis"
author: "Andreas Szukics"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
 html_document:
    # code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
    css: styles.css  # CSS file for costumized html
---

```{r, include=FALSE}

# set knit options
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

# disable scientific notation
options(scipen = 999) 

```

# Libraries

```{r}

library(tidyverse)
library(knitr)
library(kableExtra)
library(janitor)
library(ltm)
library(scales)
library(PupillometryR)
library(palmerpenguins)
library(ggdist)
library(ggExtra)
library(ggrepel)
library(remotes)
library(ggthemes)
library(ggsci)

```


# Data

## Load the processed data 

```{r}

# Loading data
data_processed <- read_csv("../data/processed/data_processed.csv")

```


# Descriptive tables

## Sample size before exclusions

```{r}

data_processed |>
  count(name = "n") |>
  kable() |>
  add_header_above(header = c("Whole sample" = 1)) |> # note that you can add header rows to tables like this. The "1" indicates the number of columns the header should span. The sum of these numbers must equal the number of columns or you'll get an error.
  kable_classic(full_width = FALSE)

```


## Dataframe without excluded subject

```{r}

# Loading only subject to be included
data_processed_after_exclusions <- data_processed |>
  filter(exclude_participant == "include")

```


## Sample size after exclusions

Sample used in subsequent analyses

```{r}

data_processed_after_exclusions |>
  count(name = "n") |>
  kable() |>
  add_header_above(header = c("Subject" = 1)) |>
  kable_classic(full_width = FALSE)

```


## Age

```{r}

data_processed_after_exclusions |>
  mutate(age = as.numeric(age)) |>
  summarise(Mean = mean(age, na.rm = TRUE),
            SD = sd(age, na.rm = TRUE)) |>
  mutate_all(.funs = janitor::round_half_up, digits = 1) |>
  kable() |>
  add_header_above(header = c("Age" = 2)) |>
  kable_classic(full_width = FALSE)

```


## Gender

```{r}

data_processed_after_exclusions |> 
  rename(Gender = gender) |>
  group_by(Gender) |> 
  summarise(n = n()) |> 
  mutate(Percent = paste0(round_half_up((n / sum(n)) * 100, 1), "%")) |>
  mutate(Gender = stringr::str_to_sentence(Gender)) |>
  kable() |>
  kable_classic(full_width = FALSE)


```


# Descriptive statistics

## Cronbach alpha calculation

```{r}

# List of subscales
subscales <- c("a", "c", "e", "n", "o")
num_items <- c(9, 9, 8, 8, 10)

# Empty list to store Cronbach's alpha values
cronbach_alphas <- list()

# Loop to compute Cronbach's alpha for each subscale
for (i in seq_along(subscales)) {
    # Generate column names for the current subscale
    selected_columns <- paste0("bfi_", subscales[i], 1:num_items[i])
  
    # Filter rows where all items in the subscale are complete (no NAs)
    dat_subscale <- data_processed_after_exclusions[, selected_columns, drop = FALSE] |>
                    na.omit()

    # Check if the subscale has sufficient data for alpha calculation
    if(nrow(dat_subscale) > 1) {
        # Cronbach's alpha
        alpha_subscale <- cronbach.alpha(dat_subscale)$alpha
    } else {
        alpha_subscale <- NA  # Assign NA if not enough data
    }
  
    # Storing alpha coefficient to a list
    cronbach_alphas[[subscales[i]]] <- alpha_subscale
}

# Convert the list to a data frame for printing
cronbach_df <- as.data.frame(cronbach_alphas, row.names = NULL)
names(cronbach_df) <- c("a", "c", "e", "n", "o")


# Print the table with kable
cronbach_df %>%
  kable(col.names = names(cronbach_df)) %>%
  kable_classic(full_width = FALSE)

# # Print Cronbach's alpha values
# print(cronbach_alphas)

```


# Plotting

## Histogramms

### BFI subscale

```{r}
# Theme for all plots
# theme_set()

#BFI A
ggplot(data_processed_after_exclusions, aes(x = mean_a)) +
  geom_histogram(position = "dodge",
                 binwidth = .1,
                 fill     = "lightblue",
                 color    = "black")+
  # regression line
  geom_vline(aes(xintercept = mean(mean_a, na.rm = TRUE)), 
             linetype = "dashed", color = "red", size = 1) +
  # defining the y and x axes
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) + 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  coord_cartesian(xlim = c(1, 6), ylim = c(1, 15)) +
  labs(title           = "BFI mean score",
       subtitle        = "Subscale A",
       x               = "Mean score",
       y               = "Count") +
   theme_clean() +
  # Editing the labs
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))

#BFI C
ggplot(data_processed_after_exclusions, aes(x = mean_c)) +
  geom_histogram(position = "dodge",
                 binwidth = .1,
                 fill     = "lightblue",
                 color    = "black")+
  # regression line
  geom_vline(aes(xintercept = mean(mean_c, na.rm = TRUE)), 
             linetype = "dashed", color = "red", size = 1) +
  # defining the y and x axes
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  coord_cartesian(xlim = c(1, 6), ylim = c(1, 15)) +
  labs(title           = "BFI mean score",
       subtitle        = "Subscale C",
       x               = "Mean score",
       y               = "Count") +
   theme_clean() +
  # Editing the labs
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))

#BFI  E
ggplot(data_processed_after_exclusions, aes(x = mean_e)) +
  geom_histogram(position = "dodge",
                 binwidth = .1,
                 fill     = "lightblue",
                 color    = "black")+
  # regression line
  geom_vline(aes(xintercept = mean(mean_e, na.rm = TRUE)), 
             linetype = "dashed", color = "red", size = 1) +
  # defining the y and x axes
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  coord_cartesian(xlim = c(1, 6), ylim = c(1, 15)) +
  labs(title           = "BFI mean score",
       subtitle        = "Subscale E",
       x               = "Mean score",
       y               = "Count") +
   theme_clean() +
  # Editing the labs
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))

#BFI N
ggplot(data_processed_after_exclusions, aes(x = mean_n)) +
  geom_histogram(position = "dodge",
                 binwidth = .1,
                 fill     = "lightblue",
                 color    = "black")+
  # regression line
  geom_vline(aes(xintercept = mean(mean_n, na.rm = TRUE)), 
             linetype = "dashed", color = "red", size = 1) +
  # defining the y and x axes
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  coord_cartesian(xlim = c(1, 6), ylim = c(1, 15)) +
  labs(title           = "BFI mean score",
       subtitle        = "Subscale N",
       x               = "Mean score",
       y               = "Count") +
   theme_clean() +
  # Editing the labs
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))

#BFI O
ggplot(data_processed_after_exclusions, aes(x = mean_o)) +
  geom_histogram(position = "dodge",
                 binwidth = .1,
                 fill     = "lightblue",
                 color    = "black")+
  # regression line
  geom_vline(aes(xintercept = mean(mean_o, na.rm = TRUE)), 
             linetype = "dashed", color = "red", size = 1) +
  # defining the y and x axes
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  coord_cartesian(xlim = c(1, 6), ylim = c(1, 15)) +
  labs(title           = "BFI mean score",
       subtitle        = "Subscale O",
       x               = "Mean score",
       y               = "Count") +
  theme_clean() +
  # Editing the labs
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))


```


### IAT

```{r}

#IAT D
ggplot(data_processed_after_exclusions, aes(x = D)) +
  geom_histogram(position = "dodge",
                 binwidth = .05,
                 fill     = "lightblue",
                 color    = "black")+
  # regression line
  geom_vline(aes(xintercept = mean(D, na.rm = TRUE)), 
             linetype = "dashed", color = "red", size = 1) +
  # defining the y and x axes
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  coord_cartesian(xlim = c(-1, .5), ylim = c(1, 15)) +
  labs(title           = "Implicit Association Test",
       subtitle        = "Greenwald \"D\" score",
       x               = "D score",
       y               = "Count") +
  theme_clean() +
  # Editing the labs
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))
```


# Data analysis tests

## Pearson's r correlation

\TODO add table of means, SDs, Ns

```{r}

# Ensuring the necessary columns are present in the data frame
required_columns <- c("D", "mean_a", "mean_c", "mean_e", "mean_n", "mean_o")
if(all(required_columns %in% names(data_processed_after_exclusions))) {
    # Calculating the correlation matrix
    correlation_matrix <- cor(data_processed_after_exclusions[required_columns], 
                              use = "pairwise.complete.obs", method = "pearson")

    # Rounding the correlation matrix to two decimal places
    correlation_matrix_rounded <- round(correlation_matrix, 2)

    # Formatting and printing the rounded correlation matrix as a table
    kable(correlation_matrix_rounded) |>  
      kable_classic(full_width = FALSE)
} else {
    cat("One or more required columns are missing from the data frame.")
}

```


## T-test

```{r}

# creating a new variable and encoding male and female
data_processed_after_exclusions$gender_numeric <- ifelse(data_processed_after_exclusions$gender == "male", 1, 0)

library(report)

model_D <- lm(D ~ gender_numeric, data = data_processed_after_exclusions)
report(model_D)

```


## Hypothesis tests

```{r}

# List of BFI subscales
subscales <- c("mean_a", "mean_c", "mean_e", "mean_n", "mean_o")

# Initialize a list to store models and their reports
model_reports <- list()

# Loop through each subscale and run a separate regression
for (subscale in subscales) {
  formula_str <- paste("D ~", subscale)
  model <- lm(as.formula(formula_str), data = data_processed_after_exclusions)
  
  # Generate the report for the model
  model_report <- report(model)
  
  # Store the model and its report in the list
  model_reports[[subscale]] <- list(model = model, report = model_report)
}

# Print the reports of each model
for (subscale in names(model_reports)) {
  cat("\nRegression with", subscale, "as predictor:\n")
  print(model_reports[[subscale]]$report)
}

```


## Facet wraps of scatter plots for all subscales predicting IAT

```{r}

library(gridExtra)
library(patchwork)

# Calculating the 10th and 90th percentiles of the IAT 'D' scores
lower_bound <- quantile(data_processed_after_exclusions$D, probs = 0.1)
upper_bound <- quantile(data_processed_after_exclusions$D, probs = 0.9)

# Creating a new variable to flag extreme scores
data_processed_after_exclusions <- data_processed_after_exclusions %>%
  mutate(extreme_score = ifelse(D <= lower_bound | D >= upper_bound, "Extreme", "Normal"))


# Reshape your data into long format for the subscales
long_data <- data_processed_after_exclusions %>%
  pivot_longer(cols = starts_with("mean_"), names_to = "Subscale", values_to = "Mean_Score")

# Define your mapping of subscale names to desired labels
subscale_labels <- c(mean_a = "Subscale A", mean_c = "Subscale C", mean_e = "Subscale E", mean_n = "Subscale N", mean_o = "Subscale O")

# Add a new column with the updated subscale names
long_data <- long_data %>%
  mutate(Subscale = factor(Subscale, levels = names(subscale_labels), labels = subscale_labels))

# Create a ggplot object with facet_wrap for each subscale
ggplot(long_data, aes(x = Mean_Score, y = D)) +
  geom_point(aes(shape = extreme_score, color = gender)) +
  scale_shape_manual(values = c("Normal" = 16, "Extreme" = 17),
                     labels = c("Extreme Score", "Normal Score")) +  # Renaming shape categories
  scale_color_manual(values = c("male" = "violet", "female" = "#0099F8"),
                     labels = c("Female", "Male")) +
  geom_smooth(method = "lm", color = "red", se = FALSE, size = .5) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  coord_cartesian(ylim = c(-1, .5)) +
  facet_wrap(~Subscale) +
  labs(title = "Scatter plot for IAT prediction",
       x = "Mean score",
       y = "D",
       shape = "Score Category",
       color = "Gender") +
  theme_clean() +
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))
  theme(legend.position = "right")

```


## Saving plots as png and pdf

## Scatter plots with regression lines

```{r}

# Scatter plot for BFI subscale 'mean_a'
p1 <- ggplot(data_processed_after_exclusions, aes(x = mean_a, y = D)) +
  geom_point(aes(shape = extreme_score, color = gender)) +
  scale_shape_manual(values = c("Normal" = 16, "Extreme" = 17),
                     labels = c("Extreme Score", "Normal Score")) +  # Renaming shape categories
  scale_color_manual(values = c("male" = "violet", "female" = "#0099F8"),
                     labels = c("Female", "Male")) +  # Renaming color categories and choosing colors
  geom_smooth(method = "lm", color = "red", se = FALSE, size = .5) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  coord_cartesian(ylim = c(-1, .5), xlim = c(1, 6)) +
  labs(title    = "Scatter plot for IAT prediction",
       subtitle = "Subscale A",
       x        = "Mean score",
       y        = "D",
       shape    = "Score Category",
       color    = "Gender") +
  theme_clean() +
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"),
        legend.position = "right")  

# Scatter plot for BFI subscale 'mean_c'
p2 <- ggplot(data_processed_after_exclusions, aes(x = mean_c, y = D)) +
  geom_point(aes(shape = extreme_score, color = gender)) +
  scale_shape_manual(values = c("Normal" = 16, "Extreme" = 17),
                     labels = c("Extreme Score", "Normal Score")) +  # Renaming shape categories
  scale_color_manual(values = c("male" = "violet", "female" = "#0099F8"),
                     labels = c("Female", "Male")) +  # Renaming color categories and specify colors
  geom_smooth(method = "lm", color = "red", se = FALSE, size = .5) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  coord_cartesian(ylim = c(-1, .5), xlim = c(1, 6)) +
  labs(title    = "Scatter plot for IAT prediction",
       subtitle = "Subscale C",
       x        = "Mean score",
       y        = "D",
       shape    = "Score Category",
       color    = "Gender") +
  theme_clean() +
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"),
        legend.position = "right")  

# Scatter plot for BFI subscale 'mean_e'
p3 <- ggplot(data_processed_after_exclusions, aes(x = mean_e, y = D)) +
  geom_point(aes(shape = extreme_score, color = gender)) +
  scale_shape_manual(values = c("Normal" = 16, "Extreme" = 17),
                     labels = c("Extreme Score", "Normal Score")) +  # Renaming shape categories
  scale_color_manual(values = c("male" = "violet", "female" = "#0099F8"),
                     labels = c("Female", "Male")) +  # Renaming color categories and specify colors
  geom_smooth(method = "lm", color = "red", se = FALSE, size = .5) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  coord_cartesian(ylim = c(-1, .5), xlim = c(1, 6)) +
  labs(title    = "Scatter plot for IAT prediction",
       subtitle = "Subscale E",
       x        = "Mean score",
       y        = "D",
       shape    = "Score Category",
       color    = "Gender") +
  theme_clean() +
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"),
        legend.position = "right")  

# Scatter plot for BFI subscale 'mean_n'
p4 <- ggplot(data_processed_after_exclusions, aes(x = mean_n, y = D)) +
  geom_point(aes(shape = extreme_score, color = gender)) +
  scale_shape_manual(values = c("Normal" = 16, "Extreme" = 17),
                     labels = c("Extreme Score", "Normal Score")) +  # Renaming shape categories
  scale_color_manual(values = c("male" = "violet", "female" = "#0099F8"),
                     labels = c("Female", "Male")) +  # Renaming color categories and specify colors
  geom_smooth(method = "lm", color = "red", se = FALSE, size = .5) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  coord_cartesian(ylim = c(-1, .5), xlim = c(1, 6)) +
  labs(title    = "Scatter plot for IAT prediction",
       subtitle = "Subscale N",
       x        = "Mean score",
       y        = "D",
       shape    = "Score Category",
       color    = "Gender") +
  theme_clean() +
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))  


# Scatter plot for BFI subscale 'mean_o'
p5 <- ggplot(data_processed_after_exclusions, aes(x = mean_o, y = D)) +
  geom_point(aes(shape = extreme_score, color = gender)) +
  scale_shape_manual(values = c("Normal" = 16, "Extreme" = 17),
                     labels = c("Extreme Score", "Normal Score")) +  # Renaming shape categories
  scale_color_manual(values = c("male" = "violet", "female" = "#0099F8"),
                     labels = c("Female", "Male")) +  # Renaming color categories and specify colors
  geom_smooth(method = "lm", color = "red", se = FALSE, size = .5) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
  coord_cartesian(ylim = c(-1, .5), xlim = c(1, 6)) +
  labs(title    = "Scatter plot for IAT prediction",
       subtitle = "Subscale O",
       x        = "Mean score",
       y        = "D",
       shape    = "Score Category",
       color    = "Gender") +
  theme_clean() +
  theme(plot.title    = element_text(color = "#0099F8", size = 16, face = "bold"),
        plot.subtitle = element_text(size = 10, face = "bold"),
        axis.title.x  = element_text(face = "bold"),
        axis.title.y  = element_text(face = "bold"))

combined_plots <- p1 + p2 + p3 + p4 + p5


#saving as png
ggsave("scatterplots.png", combined_plots, path = "../communications/", width = 20, height = 10)

#saving as pdf
ggsave("scatterplots.pdf", combined_plots, path = "../communications/", width = 20, height = 10)

```


# Session info

```{r}

sessionInfo()

```



